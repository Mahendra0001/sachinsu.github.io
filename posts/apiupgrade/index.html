<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content><meta name=description content="Introduction One of the design considerations stressed upon by Jeffrey richter about APIs (Read more here) is that &amp;ldquo;API is expected to be stable over long period of time&amp;rdquo;. Recently,for a .NET based project, we decided to upgrade some of the ASMX (legacy SOAP based approach) based APIs and were immediately reminded by Customer(s) to avoid any kind of impact on existing users.
This means that upgrade must be done keeping in mind,"><meta name=keywords content="blog,developer,personal,golang,dotnetcore,databases,architecture,c#,.net core,Vuejs,Quasar,Oracle,python,HTTP,SOAP,REST,.NET,WCF,CoreWCF,ASMX,C#"><meta name=robots content="noodp"><meta name=theme-color content><link rel=canonical href=https://sachinsu.github.io/posts/apiupgrade/><title>Upgrading API: Learnings :: Sachin Sunkle</title><link href=https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.2.1/css/flag-icon.min.css rel=stylesheet type=text/css><link rel=stylesheet href=https://sachinsu.github.io/main.dede02da9537a98158079c023e83573e18127834838ef08172acce888341a797.css><link rel=apple-touch-icon sizes=180x180 href=https://sachinsu.github.io/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://sachinsu.github.io/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://sachinsu.github.io/favicon-16x16.png><link rel=manifest href=https://sachinsu.github.io/site.webmanifest><link rel=mask-icon href=https://sachinsu.github.io/safari-pinned-tab.svg color=#252627><link rel="shortcut icon" href=https://sachinsu.github.io/favicon.ico><meta name=msapplication-TileColor content="#252627"><meta name=theme-color content="#252627"><meta itemprop=name content="Upgrading API: Learnings"><meta itemprop=description content="Introduction One of the design considerations stressed upon by Jeffrey richter about APIs (Read more here) is that &ldquo;API is expected to be stable over long period of time&rdquo;. Recently,for a .NET based project, we decided to upgrade some of the ASMX (legacy SOAP based approach) based APIs and were immediately reminded by Customer(s) to avoid any kind of impact on existing users.
This means that upgrade must be done keeping in mind,"><meta itemprop=datePublished content="2021-02-25T00:00:00+05:30"><meta itemprop=dateModified content="2021-02-25T00:00:00+05:30"><meta itemprop=wordCount content="963"><meta itemprop=keywords content="HTTP,SOAP,REST,.NET,WCF,CoreWCF,ASMX,C#,"><meta name=twitter:card content="summary"><meta name=twitter:title content="Upgrading API: Learnings"><meta name=twitter:description content="Introduction One of the design considerations stressed upon by Jeffrey richter about APIs (Read more here) is that &ldquo;API is expected to be stable over long period of time&rdquo;. Recently,for a .NET based project, we decided to upgrade some of the ASMX (legacy SOAP based approach) based APIs and were immediately reminded by Customer(s) to avoid any kind of impact on existing users.
This means that upgrade must be done keeping in mind,"><meta property="og:title" content="Upgrading API: Learnings"><meta property="og:description" content="Introduction One of the design considerations stressed upon by Jeffrey richter about APIs (Read more here) is that &ldquo;API is expected to be stable over long period of time&rdquo;. Recently,for a .NET based project, we decided to upgrade some of the ASMX (legacy SOAP based approach) based APIs and were immediately reminded by Customer(s) to avoid any kind of impact on existing users.
This means that upgrade must be done keeping in mind,"><meta property="og:type" content="article"><meta property="og:url" content="https://sachinsu.github.io/posts/apiupgrade/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-02-25T00:00:00+05:30"><meta property="article:modified_time" content="2021-02-25T00:00:00+05:30"><meta property="article:published_time" content="2021-02-25 00:00:00 +0530 +0530"></head><body><div class=container><header class=header><span class=header__inner><a href=https://sachinsu.github.io/ style=text-decoration:none><div class=logo><span class=logo__mark>></span>
<span class=logo__text>$ cd /home/</span>
<span class=logo__cursor></span></div></a><span class=header__right><nav class=menu><ul class=menu__inner><li><a href=https://sachinsu.github.io/about/>About</a></li><li><a href=https://sachinsu.github.io/posts/>Blog</a></li><li><a href=https://sachinsu.github.io/projects/>Projects</a></li><li><a href=https://gist.github.com/sachinsu>Gists</a></li><li><a href=https://sachinsu.github.io/links/home>Useful Links</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class="theme-toggle unselectable"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><main class=post><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>5 minutes</p></div><article><h1 class=post-title><a href=https://sachinsu.github.io/posts/apiupgrade/>Upgrading API: Learnings</a></h1><div class=post-content><h2 id=introduction>Introduction</h2><p>One of the design considerations stressed upon by Jeffrey richter about APIs (Read more <a href=https://sachinsu.github.io/posts/restapiversioning/>here</a>) is that &ldquo;API is expected to be stable over long period of time&rdquo;. Recently,for a .NET based project, we decided to upgrade some of the ASMX (legacy SOAP based approach) based APIs and were immediately reminded by Customer(s) to avoid any kind of impact on existing users.</p><p>This means that upgrade must be done keeping in mind,</p><ul><li>No changes to API Contract (SOAP remains SOAP and so on)</li><li>No changes to URLs</li><li>Testing to ensure no impact</li></ul><p>Initial plan was to move away from SOAP to adopt REST based approach. This thinking was aided by fact that .NET core may not support WCF (framework that supports SOAP apart from ASMX Web Services) in addition to other aspects like simplicity and wide adoption of REST. However, even microsoft has now decided to support WCF in .NET Core via <a href=https://github.com/CoreWCF/CoreWCF>CoreWCF</a>.</p><p>With this constraints, below alternatives were considered to upgrade ASMX based services to WCF (the only other framework that supports SOAP based services),</p><table><thead><tr><th style=text-align:left>Approach</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left>Have existing ASMX Service call new WCF Service using Async/Await</td><td style=text-align:left>This involves hosting additional WCF Service and making HTTP requests to it. It also means maintaining both ASMX & WCF endpoints. Also to be mindful of latency introduced due to HTTP communication between the two.</td></tr><tr><td style=text-align:left>New WCF Service and URL Rewrite rules to handle requests to ASMX</td><td style=text-align:left>This involves developing new WCF Service, compatible to current service contract, and configuration to route/re-write incoming requests to new service. Existing ASMX end point can be sunset</td></tr><tr><td style=text-align:left>New WCF Service and mapping <code>.asmx</code> handler to WCF handler</td><td style=text-align:left>This involves developing new WCF Service,compatible to current service contract, and configuration so that requests to <code>.asmx</code> url will be served by WCF handler. Existing ASMX end point can be sunset.</td></tr></tbody></table><p>Lets go through above approaches in detail.</p><h2 id=wcf-service-invoked-from-asmx-asynchronously>WCF service invoked from ASMX asynchronously</h2><p>This involves developing new WCF Service. Existing ASMX based web service will be modified to invoke new WCF Service. Asynchronously invocation should help in this case since whole operation is I/O bound (<code>Asynchrony is a way to get concurrency without multithreading. E.g., freeing up the calling thread instead of blocking it while an I/O operation is in progress</code> Stephen Cleary). Since ASMX is legacy framework and only support Event-based asynchronous pattern (EAP), it is necessary to combine EAP with Task based asynchronous pattern (TAP) which is what async/await uses. Below is sample snippet,</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback> private async Task&lt;string&gt; FooAsync(int arg)
        {
            using (var resp = await client.GetAsync(string.Format(&#34;https://jsonplaceholder.typicode.com/todos/{0}&#34;, arg)).ConfigureAwait(false)) {
                resp.EnsureSuccessStatusCode();

                using (var contentStream = await resp.Content.ReadAsStreamAsync().ConfigureAwait(false)) { 

                    APIResponse obj = await JsonSerializer.DeserializeAsync&lt;APIResponse&gt;(contentStream).ConfigureAwait(false);

                   string output =  string.Format(&#34;{0} at {1}&#34;, obj.Title, DateTime.Now.Ticks);
                    System.Diagnostics.Debug.WriteLine(output);
                    return output;
                }
            }

        }

        [WebMethod]
        public IAsyncResult BeginFoo(int arg, AsyncCallback callback, object state)
        {
            return FooAsync(arg).ToApm(callback, state);           
        }

        [WebMethod]
        public string EndFoo(IAsyncResult result)
        {
            try
            {
                return ((Task&lt;string&gt;)result).Result;
            }
            catch (AggregateException ae) { throw ae.InnerException; }
        }

</code></pre></div><p>Where <code>ToApm</code> is extension function from Stephen Toub&rsquo;s excellent blog (link in code as comment),</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>
        public static Task&lt;TResult&gt; ToApm&lt;TResult&gt;(this Task&lt;TResult&gt; task, AsyncCallback callback, object state)
        {
            if (task.AsyncState == state)
            {
                if (callback != null)
                {
                    task.ContinueWith(delegate { callback(task); },
                        CancellationToken.None, TaskContinuationOptions.None, TaskScheduler.Default);
                }
                return task;
            }

            var tcs = new TaskCompletionSource&lt;TResult&gt;(state);
            task.ContinueWith(delegate
            {
                if (task.IsFaulted) tcs.TrySetException(task.Exception.InnerExceptions);
                else if (task.IsCanceled) tcs.TrySetCanceled();
                else tcs.TrySetResult(task.Result);

                if (callback != null) callback(tcs.Task);

            }, CancellationToken.None, TaskContinuationOptions.None, TaskScheduler.Default);
            return tcs.Task;
        }

</code></pre></div><p>This approach involves,</p><ul><li>hosting and maintaining both (current and new) API end-points.</li><li>We also came across issues where async/await was not working properly in case code blocks.</li><li>Measuring and mitigating any latency induced due to this additional hop</li><li>Additional Monitoring and logging to track WCF end-point</li></ul><p>We decided to explore alternative approaches instead of this.</p><h2 id=wcf-service-with-url-re-write>WCF service with URL re-write</h2><p>This requires hosting WCF Service which is backward compatible with ASMX based SOAP implementation.</p><p>Typically this involves,</p><ul><li>supporting <code>basicHttpBinding</code></li><li>Adding namespaces and support for XML Serialization to Service contract like,</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>
  [ServiceContract(Name = &#34;RequestReplyService&#34;, Namespace = &#34;http://tempuri.org/&#34;),XmlSerializerFormat]

</code></pre></div><ul><li>Adding Action to OperationContract attribute like,</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>[OperationContract(IsOneWay = false, Action = &#34;http://tempuri.org/DoWork&#34;)]

</code></pre></div><p>Additional configuration to re-write incoming requests to <code>.asmx</code> to new service in <code>web.config</code> as below,</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>
 &lt;system.webServer&gt;
    &lt;validation validateIntegratedModeConfiguration=&#34;false&#34; /&gt;    
    &lt;rewrite&gt;
      &lt;rules&gt;
        &lt;rule name=&#34;asmxtosvc&#34; stopProcessing=&#34;true&#34;&gt;
          &lt;match url=&#34;^service.asmx(.*)$&#34; /&gt;
          &lt;action type=&#34;Rewrite&#34; url=&#34;Service.svc{R:1}&#34;/&gt;
        &lt;/rule&gt;
      &lt;/rules&gt;
    &lt;/rewrite&gt;
  &lt;/system.webServer&gt;

</code></pre></div><p>One may want to test above re-write settings in IIS as older versions of it require installation of URL Rewrite module.</p><p>This is followed by testing new WCF service from existing client(s), be it .NET based clients or other ones with no changes. .NET based clients typically invoke service through generated proxy class. For other clients, we basically simulated it via Postman.</p><p>This approach provides cleaner implementation vis-a-vis earlier approach such that it is still new WCF based implementation with no ASMX in use.</p><h2 id=wcf-service-with-asmx-extension-mapped-to-wcf-handler>WCF service with .asmx extension mapped to WCF handler</h2><p>This approach is very similar to last one with only change being instead of using URL re-write module, we will map <code>.asmx</code> extension to WCF Handler. So the changes are only in web.config as below,</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>
&lt;system.web&gt;
    &lt;httpHandlers&gt;
    &lt;remove path=&#34;.asmx&#34; verb=&#34;*&#34; /&gt;
    &lt;add path=&#34;*.asmx&#34; verb=&#34;*&#34; type=&#34;System.ServiceModel.Activation.HttpHandler, System.ServiceModel, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089&#34; validate=&#34;false&#34; /&gt;
    &lt;/httpHandlers&gt;
    &lt;compilation debug=&#34;true&#34; targetFramework=&#34;4.8&#34;&gt;
    &lt;buildProviders&gt;
        &lt;remove extension=&#34;.asmx&#34;/&gt;
        &lt;add extension=&#34;.asmx&#34; type=&#34;System.ServiceModel.Activation.ServiceBuildProvider, System.ServiceModel, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089&#34;/&gt;
      &lt;/buildProviders&gt;
    &lt;/compilation&gt;
    &lt;httpRuntime targetFramework=&#34;4.8&#34;/&gt;
  &lt;/system.web&gt;
....


&lt;system.webServer&gt;
  &lt;handlers&gt;
    &lt;remove name=&#34;WebServiceHandlerFactory-Integrated&#34;/&gt;
    &lt;add name=&#34;MyNewAsmxHandler&#34; path=&#34;*.asmx&#34; verb=&#34;*&#34; type=&#34;System.ServiceModel.Activation.HttpHandler, System.ServiceModel.Activation, Version=4.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35&#34; /&gt;
  &lt;/handlers&gt;
  &lt;validation validateIntegratedModeConfiguration=&#34;false&#34; /&gt;
&lt;/system.webServer&gt;

</code></pre></div><p>This was tested in same way as earlier with existing .NET and other clients.</p><p>This feels like even more cleaner approach than using URL re-write as it doesn&rsquo;t involve using any additional module/library.</p><p>Finally, we went ahead with this approach.</p><p>Hopefully,this article will be helpful to anyone involved in legacy modernization initiatives.</p><h3 id=useful-references>Useful References</h3><ul><li><a href=https://docs.microsoft.com/en-us/dotnet/framework/wcf/feature-details/comparing-aspnet-web-services-to-wcf-based-on-development>Comparing ASMX web services to WCF</a></li><li><a href=https://devblogs.microsoft.com/pfxteam/using-tasks-to-implement-the-apm-pattern/>APM Pattern using Tasks</a></li><li><a href=https://blog.stephencleary.com/2012/08/async-wcf-today-and-tomorrow.html>Async in WCF</a></li><li><a href=https://docs.microsoft.com/en-us/dotnet/framework/wcf/feature-details/comparing-aspnet-web-services-to-wcf-based-on-development>Comparing ASMX with WCF</a></li><li><a href=https://stackoverflow.com/questions/5686320/asmx-to-wcf-conversion>Discussion on ASMX to WCF</a></li></ul><p>Happy Coding !!</p><hr><script src=https://utteranc.es/client.js repo=sachinsu/sachinsu.github.io issue-term=title label=blogcomment theme=github-light crossorigin=anonymous async></script></div></article><hr><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=tag><a href=https://sachinsu.github.io/tags/http>HTTP</a></span><span class=tag><a href=https://sachinsu.github.io/tags/soap>SOAP</a></span><span class=tag><a href=https://sachinsu.github.io/tags/rest>REST</a></span><span class=tag><a href=https://sachinsu.github.io/tags/.net>.NET</a></span><span class=tag><a href=https://sachinsu.github.io/tags/wcf>WCF</a></span><span class=tag><a href=https://sachinsu.github.io/tags/corewcf>CoreWCF</a></span><span class=tag><a href=https://sachinsu.github.io/tags/asmx>ASMX</a></span><span class=tag><a href=https://sachinsu.github.io/tags/c>C#</a></span></p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>963 Words</p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>2021-02-24 18:30 +0000</p></div><div class=pagination><div class=pagination__title><span class=pagination__title-h></span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://sachinsu.github.io/posts/elt/><span class=button__icon>←</span>
<span class=button__text>ELT approach to Data Pipeline</span></a></span>
<span class="button next"><a href=https://sachinsu.github.io/posts/restapiversioning/><span class=button__text>Learnings from Jeff Richter's Designing and Versioning HTTP REST APIs Video Course</span>
<span class=button__icon>→</span></a></span></div></div></main></div><footer class=footer><div class=footer__inner><div class=footer__content><span>&copy; 2021</span>
<span><a href=https://sachinsu.github.io/posts/index.xml target=_blank title=rss><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></span></div></div><div class=footer__inner><div class=footer__content><span>Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>Made with &#10084; by <a href=https://github.com/rhazdon>Djordje Atlialp</a></span></div></div></footer></div><script type=text/javascript src=https://sachinsu.github.io/bundle.min.a0f363fdf81cdc5cfacc447a79c33189eb000d090336cd04aac8ee256f423b3133b836c281944c19c75e38d0b0b449f01ce5807e37798b7ac94ac1db51983fc4.js integrity="sha512-oPNj/fgc3Fz6zER6ecMxiesADQkDNs0EqsjuJW9COzEzuDbCgZRMGcdeONCwtEnwHOWAfjd5i3rJSsHbUZg/xA=="></script><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-169012216-1','auto'),ga('send','pageview'))</script></body></html>