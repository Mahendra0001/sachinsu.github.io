<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content><meta name=description content="Background I recently had opportunity to support team who has been battling with Intermittent (scary i know :)) issues with TCP connectivity in Production.
Simplified deployment Architecture is as below,
  High Level Architecture   Technology Stack used is Microsoft .NET Framework 4.8 using ODP.NET for Oracle Connectivity (Oracle Server is 8 CPU box). Each of Web Servers in cluster have IIS hosted on it with multiple Applications (Application domains) serving HTTP(s) based traffic."><meta name=keywords content="blog,developer,personal,golang,dotnetcore,databases,architecture,c#,.net core,Vuejs,Quasar,Oracle,python,Oracle,TCP,Firewall,.NET,Polly"><meta name=robots content="noodp"><meta name=theme-color content><link rel=canonical href=https://sachinsu.github.io/posts/connectiontimeouts/><title>Trobleshooting TCP Connection request time outs :: Sachin Sunkle</title><link href=https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.2.1/css/flag-icon.min.css rel=stylesheet type=text/css><link rel=stylesheet href=https://sachinsu.github.io/main.dede02da9537a98158079c023e83573e18127834838ef08172acce888341a797.css><link rel=apple-touch-icon sizes=180x180 href=https://sachinsu.github.io/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://sachinsu.github.io/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://sachinsu.github.io/favicon-16x16.png><link rel=manifest href=https://sachinsu.github.io/site.webmanifest><link rel=mask-icon href=https://sachinsu.github.io/safari-pinned-tab.svg color=#252627><link rel="shortcut icon" href=https://sachinsu.github.io/favicon.ico><meta name=msapplication-TileColor content="#252627"><meta name=theme-color content="#252627"><meta itemprop=name content="Trobleshooting TCP Connection request time outs"><meta itemprop=description content="Background I recently had opportunity to support team who has been battling with Intermittent (scary i know :)) issues with TCP connectivity in Production.
Simplified deployment Architecture is as below,
  High Level Architecture   Technology Stack used is Microsoft .NET Framework 4.8 using ODP.NET for Oracle Connectivity (Oracle Server is 8 CPU box). Each of Web Servers in cluster have IIS hosted on it with multiple Applications (Application domains) serving HTTP(s) based traffic."><meta itemprop=datePublished content="2020-08-25T10:25:04+05:30"><meta itemprop=dateModified content="2020-08-25T10:25:04+05:30"><meta itemprop=wordCount content="829"><meta itemprop=keywords content="Oracle,TCP,Firewall,.NET,Polly,"><meta name=twitter:card content="summary"><meta name=twitter:title content="Trobleshooting TCP Connection request time outs"><meta name=twitter:description content="Background I recently had opportunity to support team who has been battling with Intermittent (scary i know :)) issues with TCP connectivity in Production.
Simplified deployment Architecture is as below,
  High Level Architecture   Technology Stack used is Microsoft .NET Framework 4.8 using ODP.NET for Oracle Connectivity (Oracle Server is 8 CPU box). Each of Web Servers in cluster have IIS hosted on it with multiple Applications (Application domains) serving HTTP(s) based traffic."><meta property="og:title" content="Trobleshooting TCP Connection request time outs"><meta property="og:description" content="Background I recently had opportunity to support team who has been battling with Intermittent (scary i know :)) issues with TCP connectivity in Production.
Simplified deployment Architecture is as below,
  High Level Architecture   Technology Stack used is Microsoft .NET Framework 4.8 using ODP.NET for Oracle Connectivity (Oracle Server is 8 CPU box). Each of Web Servers in cluster have IIS hosted on it with multiple Applications (Application domains) serving HTTP(s) based traffic."><meta property="og:type" content="article"><meta property="og:url" content="https://sachinsu.github.io/posts/connectiontimeouts/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-08-25T10:25:04+05:30"><meta property="article:modified_time" content="2020-08-25T10:25:04+05:30"><meta property="article:published_time" content="2020-08-25 10:25:04 +0530 +0530"></head><body><div class=container><header class=header><span class=header__inner><a href=https://sachinsu.github.io/ style=text-decoration:none><div class=logo><span class=logo__mark>></span>
<span class=logo__text>$ cd /home/</span>
<span class=logo__cursor></span></div></a><span class=header__right><nav class=menu><ul class=menu__inner><li><a href=https://sachinsu.github.io/about/>About</a></li><li><a href=https://sachinsu.github.io/posts/>Blog</a></li><li><a href=https://sachinsu.github.io/projects/>Projects</a></li><li><a href=https://gist.github.com/sachinsu>Gists</a></li><li><a href=https://sachinsu.github.io/links/home>Useful Links</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class="theme-toggle unselectable"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><main class=post><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>4 minutes</p></div><article><h1 class=post-title><a href=https://sachinsu.github.io/posts/connectiontimeouts/>Trobleshooting TCP Connection request time outs</a></h1><div class=post-content><h2 id=background>Background</h2><p>I recently had opportunity to support team who has been battling with Intermittent (scary i know :)) issues with TCP connectivity in Production.</p><p>Simplified deployment Architecture is as below,</p><figure><img src=https://sachinsu.github.io/images/conntimeoutarch.png><figcaption><h4>High Level Architecture</h4></figcaption></figure><p>Technology Stack used is Microsoft .NET Framework 4.8 using ODP.NET for Oracle Connectivity (Oracle Server is 8 CPU box). Each of Web Servers in cluster have IIS hosted on it with multiple Applications (Application domains) serving HTTP(s) based traffic. These applications connect to Oracle Database.</p><p>Team is experienced in developing and running .NET Apps, but they needed help to diagnose and fix &ldquo;Connection request timed out&rdquo; exceptions being thrown while connecting to backend database.</p><h2 id=problem-statement>Problem Statement</h2><p>Host of .NET Applications (Web Applications, Web APIs) connect to Oracle Database. Each of them use <a href=https://www.oracle.com/database/technologies/appdev/dotnet/odp.html>ODP.NET</a>. ODP.NET maintains connection pool per Application domain (Database resident Connection pool is not used). Some of these applications receive high number of requests per second compared to others.</p><p><code>Oracle.ManagedDataAccess.Client.OracleException (0x80004005): Connection request timed out....</code> has been reported randomly which results in failure of business transactions. ODP.NET provides extensive trace and along with above trace also contains <code>OracleInternal.Network.NetworkException (0x80004005): Network Transport: TCP transport address connect failure ---> System.Net.Sockets.SocketException (0x80004005): A connection attempt failed because the connected party did not properly respond after a period of time, or established connection failed because connected host has failed to respond</code></p><p>Specifically, Applications, receiving less traffic, were reporting it often compared to those with high traffic.</p><h2 id=approach>Approach</h2><ul><li>Simulate the Exception in Test Environment - We decided to try and simulate this exception in a Test Environment. Test environment is scaled down (50%) compared to production. Random Exceptions in production could not be simulated due to lack of Test Automation. for example, In Production, each server receives traffic for multiple HTTP End points whereas in Test environment, load testing was being done only against Single Application.</li></ul><p>This was like a end of the road since simulation would have greatly helped in diagnosing the issue. However, the show must go on so we decided to,</p><ul><li><p>Check online documentation regarding this exception,</p><ul><li><p>&ldquo;Pooled&rdquo; or &ldquo;Non-pooled&rdquo; Connection - Whenever, ODP.NET raises &ldquo;..timed out&rdquo; error, it diffrentiates the same to indicate whether error is due to delay in retrieving connection from pool or if it is due to delay from the database server (Ref: <a href=https://docs.oracle.com/en/database/oracle/oracle-data-access-components/19.3/odpnt/featConnecting.html#GUID-1152D13D-464C-4FE7-9949-32FCA9572B59>Here</a>). From this, it was clear that issue is clearly due to delay in obtaining response from database server.While this was happening , Database server (8 CPU Core box) was reporting less than 50% CPU Usage but it still had large number of inactive sessions originated from IIS Servers.</p></li><li><p>Since the exception was reported frequently in low traffic applications, it was decided to track and verify the same on firewall and database server,</p><ul><li><p>Firewall - Firewall had TCP Timeout of 30 minutes and maintains detailed log of sessions. Quick analysis of it revealed that,</p><ul><li>Production Environment - Unusually high number of sessions were being destroyed due to &ldquo;Age out&rdquo; (i.e. time out)</li><li>Test Environment - No abnormal activity was reported. Most probably because of differences in traffic.</li></ul></li><li><p>Database Server - Listener Log on Oracle Database server did not had any log entry for request at the precise time when Application(s) had reported Exception.</p></li></ul></li><li><p>Next is to check settings in Application for connectivity with Oracle. Though ODP.NET does not have any direct &ldquo;Time out&rdquo; or &ldquo;Time to live&rdquo; settings, it does provide few parameters that can influence it,</p><ul><li>&ldquo;Connection Lifetime&rdquo; - ODP.NET uses this whenever Connection is closed and disposed by the Application. It will be destroyed (after maintaining number of connections as per &ldquo;Min Pool Size&rdquo;) if it has exceeded life time. For whatever reasons, this was set to unusually high duration (i.e. 90000 seconds).</li><li>&ldquo;Connection Timeout&rdquo; - Period for which ODP.NET waits for the connection to be made available. This was set to 60 Seconds.</li></ul></li><li><p>Oracle has articles titled &ldquo;ODP-1000 &ldquo;Connection Request Timed Out&rdquo; Explained&rdquo; and &ldquo;Resolving Problems with Connection Idle Timeout With Firewall (Doc ID 257650.1)&rdquo; where it primarily recommends measures for tuning Application as well as database.</p></li></ul><p>On the basis of above, it was decided to modify the code for below,</p><ul><li>Thorough code review to verify that every ODP.NET Project is closed/disposed.</li><li>Upgrade ODP.NET to latest version (v19.8.0 as of this writing)</li><li>Turn &ldquo;KeepAlive&rdquo; while connecting to database</li><li>Leverage ODP.NET tracing in case of exception</li><li>Modify the connection lifetime to be less than time out at firewall and increase the &ldquo;Time out&rdquo; period.</li><li>Introduce Retry functionality using Excellent <a href=https://github.com/App-vNext/Polly>Polly</a> library with exponential back-off.</li></ul><p><code><iframe src="//carbon.now.sh/embed/d3888ab4418b937a650e880ec4682653?filename=extensions.cs" style=transform:scale(.9);width:1024px;height:473px;border:0;overflow:hidden sandbox="allow-scripts allow-same-origin"></iframe></code></p><p>These changes have been deployed to production and so far % of &ldquo;Connection Request Timed out&rdquo; errors have gone down significantly.</p></li></ul><h2 id=wrap-up>Wrap up</h2><p>Some key areas of focus are,</p><ul><li>For a distributed system, Always validate assumptions by dignosing end to end.</li><li>Plan to have test automation readyness to simulate production like load.</li><li>Monitoring the behavior end to end using logs.</li><li>Currently, Pool settings across applications is not optimal going by Oracle Real world Guidelines, also be mindful of <a href=https://docs.oracle.com/en/database/oracle/oracle-database/18/adfns/connection_strategies.html>Connection Storms</a></li></ul><p>Happy Troubleshooting !!</p><hr><script src=https://utteranc.es/client.js repo=sachinsu/sachinsu.github.io issue-term=title label=blogcomment theme=github-light crossorigin=anonymous async></script></div></article><hr><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=tag><a href=https://sachinsu.github.io/tags/oracle>Oracle</a></span><span class=tag><a href=https://sachinsu.github.io/tags/tcp>TCP</a></span><span class=tag><a href=https://sachinsu.github.io/tags/firewall>Firewall</a></span><span class=tag><a href=https://sachinsu.github.io/tags/.net>.NET</a></span><span class=tag><a href=https://sachinsu.github.io/tags/polly>Polly</a></span></p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>829 Words</p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>2020-08-25 04:55 +0000</p></div><div class=pagination><div class=pagination__title><span class=pagination__title-h></span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://sachinsu.github.io/posts/urlhealthchecks/><span class=button__icon>←</span>
<span class=button__text>Validating urls from 'Useful Links' section using bash / command line tools</span></a></span>
<span class="button next"><a href=https://sachinsu.github.io/posts/massdmgolang/><span class=button__text>Tool to mass DM followers on Twitter in Go</span>
<span class=button__icon>→</span></a></span></div></div></main></div><footer class=footer><div class=footer__inner><div class=footer__content><span>&copy; 2021</span>
<span><a href=https://sachinsu.github.io/posts/index.xml target=_blank title=rss><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></span></div></div><div class=footer__inner><div class=footer__content><span>Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>Made with &#10084; by <a href=https://github.com/rhazdon>Djordje Atlialp</a></span></div></div></footer></div><script type=text/javascript src=https://sachinsu.github.io/bundle.min.a0f363fdf81cdc5cfacc447a79c33189eb000d090336cd04aac8ee256f423b3133b836c281944c19c75e38d0b0b449f01ce5807e37798b7ac94ac1db51983fc4.js integrity="sha512-oPNj/fgc3Fz6zER6ecMxiesADQkDNs0EqsjuJW9COzEzuDbCgZRMGcdeONCwtEnwHOWAfjd5i3rJSsHbUZg/xA=="></script><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-169012216-1','auto'),ga('send','pageview'))</script></body></html>