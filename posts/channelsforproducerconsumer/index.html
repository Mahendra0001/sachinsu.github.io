<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content><meta name=description content="Background Recently, i got involved in assignment where in an application was facing issues with throughput. Expectation is to support more than 500 transactions per second while load testing results were indicating system was experiencing high latency beyond 100+ transactions per second.
This application is developed in .NET Framework + .NET Core and primarily uses Relational Database for persistence and has point to point integration (mainly over HTTP) with internal &amp;amp; external application(s)."><meta name=keywords content="blog,developer,personal,golang,dotnetcore,databases,architecture,c#,.net core,Vuejs,Quasar,Oracle,python,.net core,channels"><meta name=robots content="noodp"><meta name=theme-color content><link rel=canonical href=https://sachinsu.github.io/posts/channelsforproducerconsumer/><title>Using Channels for High performance Producer consumer implementation :: Sachin Sunkle</title><link href=https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.2.1/css/flag-icon.min.css rel=stylesheet type=text/css><link rel=stylesheet href=https://sachinsu.github.io/main.dede02da9537a98158079c023e83573e18127834838ef08172acce888341a797.css><link rel=apple-touch-icon sizes=180x180 href=https://sachinsu.github.io/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://sachinsu.github.io/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://sachinsu.github.io/favicon-16x16.png><link rel=manifest href=https://sachinsu.github.io/site.webmanifest><link rel=mask-icon href=https://sachinsu.github.io/safari-pinned-tab.svg color=#252627><link rel="shortcut icon" href=https://sachinsu.github.io/favicon.ico><meta name=msapplication-TileColor content="#252627"><meta name=theme-color content="#252627"><meta itemprop=name content="Using Channels for High performance Producer consumer implementation"><meta itemprop=description content="Background Recently, i got involved in assignment where in an application was facing issues with throughput. Expectation is to support more than 500 transactions per second while load testing results were indicating system was experiencing high latency beyond 100+ transactions per second.
This application is developed in .NET Framework + .NET Core and primarily uses Relational Database for persistence and has point to point integration (mainly over HTTP) with internal & external application(s)."><meta itemprop=datePublished content="2020-02-12T10:25:04+05:30"><meta itemprop=dateModified content="2020-02-12T10:25:04+05:30"><meta itemprop=wordCount content="476"><meta itemprop=keywords content=".net core,channels,"><meta name=twitter:card content="summary"><meta name=twitter:title content="Using Channels for High performance Producer consumer implementation"><meta name=twitter:description content="Background Recently, i got involved in assignment where in an application was facing issues with throughput. Expectation is to support more than 500 transactions per second while load testing results were indicating system was experiencing high latency beyond 100+ transactions per second.
This application is developed in .NET Framework + .NET Core and primarily uses Relational Database for persistence and has point to point integration (mainly over HTTP) with internal & external application(s)."><meta property="og:title" content="Using Channels for High performance Producer consumer implementation"><meta property="og:description" content="Background Recently, i got involved in assignment where in an application was facing issues with throughput. Expectation is to support more than 500 transactions per second while load testing results were indicating system was experiencing high latency beyond 100+ transactions per second.
This application is developed in .NET Framework + .NET Core and primarily uses Relational Database for persistence and has point to point integration (mainly over HTTP) with internal & external application(s)."><meta property="og:type" content="article"><meta property="og:url" content="https://sachinsu.github.io/posts/channelsforproducerconsumer/"><meta property="article:published_time" content="2020-02-12T10:25:04+05:30"><meta property="article:modified_time" content="2020-02-12T10:25:04+05:30"><meta property="article:published_time" content="2020-02-12 10:25:04 +0530 +0530"></head><body><div class=container><header class=header><span class=header__inner><a href=https://sachinsu.github.io/ style=text-decoration:none><div class=logo><span class=logo__mark>></span>
<span class=logo__text>$ cd /home/</span>
<span class=logo__cursor></span></div></a><span class=header__right><nav class=menu><ul class=menu__inner><li><a href=https://sachinsu.github.io/about/>About</a></li><li><a href=https://sachinsu.github.io/posts/>Blog</a></li><li><a href=https://sachinsu.github.io/projects/>Projects</a></li><li><a href=https://gist.github.com/sachinsu>Gists</a></li><li><a href=https://sachinsu.github.io/links/home>Useful Links</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class="theme-toggle unselectable"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41C32.4934 41 41 32.4934 41 22 41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><main class=post><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>3 minutes</p></div><article><h1 class=post-title><a href=https://sachinsu.github.io/posts/channelsforproducerconsumer/>Using Channels for High performance Producer consumer implementation</a></h1><div class=post-content><h2 id=background>Background</h2><p>Recently, i got involved in assignment where in an application was facing issues with throughput. Expectation is to support more than 500 transactions per second while load testing results were indicating system was experiencing high latency beyond 100+ transactions per second.</p><p>This application is developed in .NET Framework + .NET Core and primarily uses Relational Database for persistence and has point to point integration (mainly over HTTP) with internal & external application(s).</p><h2 id=approach>Approach</h2><p>The high level approach decided to perform diagnostics and subsequent corrective action(s) were,</p><ul><li>Benchmark code that involves Database and take corrective action</li><li>Identify tasks in hot code path that could potentially be decoupled or done in fire-n-forget mode.</li></ul><p>For point 2 from above, some of the tasks identified were,</p><ul><li>Sending Email/SMS on myriad of events</li><li>Integration with External Applications over HTTP</li></ul><p>Next task was to arrive at approach on how to perform them effectively outside of hot code path without incurring need of any additional resources (hardware or software)as far as possible. Accordingly, we had two options,</p><ul><li><em>Polling</em> - Periodically polling database to check for occurance of event and then performing the action.</li><li><em>Event Driven</em> - Using Event notification feature of database (e.g. <a href=https://www.postgresql.org/docs/current/sql-notify.html>Listen/Notify</a> in PostgreSQL or <a href=https://docs.oracle.com/cd/B28359_01/appdev.111/b28424/adfns_cqn.htm>Change Notification</a>/<a href=https://www.oracle.com/database/technologies/advanced-queuing.html>Advanced Queuing</a> in Oracle).</li></ul><p>We decided to go with <em>Event driven</em> as,</p><ul><li>Cleaner approach that doesn&rsquo;t require perodically checking for events thus consuming a database connection and more code.</li><li>We may have to have more than one such daemons to cater to different events in application.</li></ul><p>Post finalizing on event driven approach for gathering events, next task was to determine how to effectively send email/sms or any other HTTP requests considering that rate of arrival of events will not be matching rate of processing them. Also these</p><p>So what are the options available in .NET Ecosystem, Below are the ones i am aware of,</p><ul><li><a href=https://devblogs.microsoft.com/dotnet/an-introduction-to-system-threading-channels/>Channels</a> - High performance implementation of In-memory producer/consumer pattern.</li><li><a href=https://docs.microsoft.com/en-us/dotnet/standard/parallel-programming/dataflow-task-parallel-library>TPL Dataflow</a> - Super set of Channels Library. Aimed at use cases where blocks of logic are to be linked together to same or different consumers and so on. Also all these features come with additional overheads.</li></ul><p>For the task at hand, functionality offered by Channels is sufficient to implement in-memory producer consumer pattern.</p><p>So we wrapped above event processing in a Windows service implemented as <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/host/hosted-services?view=aspnetcore-3.1&tabs=visual-studio">.NET Core Worker
Service</a></p><p>Generic Implementation is as follows,</p><ul><li><p>Event Generator - In practice, this class will be responsible for wiring up to receive events from database</p></li><li><p>Event Consumer which uses channels to process events in parallel</p></li></ul><iframe src=//carbon.now.sh/embed/6fcbc36e6e5cc58c7b5ba9007e276afc style=transform:scale(0.9);width:1024px;height:473px;border:0;overflow:hidden sandbox="allow-scripts allow-same-origin"></iframe><p>Refer Gist <a href=https://gist.github.com/sachinsu/6fcbc36e6e5cc58c7b5ba9007e276afc>here</a></p><h2 id=summary>Summary</h2><p>Other languages (notably <a href=https://tour.golang.org/concurrency/2>Channels in Go</a>) have been providing out of the box implementation for in-memory producer with concurrent, parallel consumers. With Channels, .NET Ecosystem finally has construct that can be effectively put to use for high performance, concurrent use cases.</p><h3 id=useful-references>Useful References,</h3><ul><li><a href=https://docs.microsoft.com/en-us/dotnet/csharp/event-pattern#defining-and-raising-field-like-events>Event Pattern in C#</a></li><li><a href=https://gist.github.com/AlgorithmsAreCool/b0960ce8a3400305e43fe8ffdf89b32c>Gist on using Channels</a></li></ul><p>Happy Coding !!</p><hr><script src=https://utteranc.es/client.js repo=sachinsu/sachinsu.github.io issue-term=title label=blogcomment theme=github-light crossorigin=anonymous async></script></div></article><hr><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=tag><a href=https://sachinsu.github.io/tags/.net-core>.net core</a></span><span class=tag><a href=https://sachinsu.github.io/tags/channels>channels</a></span></p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>476 Words</p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>2020-02-12 04:55 +0000</p></div><div class=pagination><div class=pagination__title><span class=pagination__title-h></span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://sachinsu.github.io/posts/samesitecookies/><span class=button__icon>←</span>
<span class=button__text>ASP.NET Core - Mind the SameSite HTTP Cookie settings</span></a></span>
<span class="button next"><a href=https://sachinsu.github.io/posts/dotnetstandard/><span class=button__text>Using .NET standard Assembly in .NET core and .NET Framework</span>
<span class=button__icon>→</span></a></span></div></div></main></div><footer class=footer><div class=footer__inner><div class=footer__content><span>&copy; 2020</span>
<span><a href=https://sachinsu.github.io/posts/index.xml target=_blank title=rss><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></span></div></div><div class=footer__inner><div class=footer__content><span>Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>Made with &#10084; by <a href=https://github.com/rhazdon>Djordje Atlialp</a></span></div></div></footer></div><script type=text/javascript src=https://sachinsu.github.io/bundle.min.dc716e9092c9820b77f96da294d0120aeeb189b5bcea9752309ebea27fd53bbe6b13cffb2aca8ecf32525647ceb7001f76091de4199ac5a3caa432c070247f5b.js integrity="sha512-3HFukJLJggt3+W2ilNASCu6xibW86pdSMJ6+on/VO75rE8/7KsqOzzJSVkfOtwAfdgkd5BmaxaPKpDLAcCR/Ww=="></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-169012216-1','auto');ga('send','pageview');}</script></body></html>